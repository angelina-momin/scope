---
title: "Scoping Review Report"
date: "`r Sys.Date()`"
output: pdf_document
---


```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r setup, include = FALSE, echo = FALSE}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  tidyverse,
  janitor,
  inspectdf,
  here,
  readxl,
  flextable,
  ggplot2,
  dplyr,
  tidyr
)

# Load data
fulldata <- read_excel(here("fulldata.xlsx"))

# Clean fulldata  by removing all line breaks
fulldata[] <- lapply(fulldata, function(x) gsub("\n|\r", "", x))

## Data cleaning and replacement ##
fulldata$study_design_short <- gsub("post_only", "post only", fulldata$study_design_short)
fulldata$intervention_class <- gsub("Other", "Other interventions", fulldata$intervention_class)
fulldata$intervention_exact <- gsub("(p-value calibraration) - statistical technique", "p-value calibration", fulldata$intervention_exact)

fulldata$outcomes_short <- ifelse(fulldata$outcomes_class == "reporting specific elements", "other outcomes", fulldata$outcomes_short)
fulldata$outcomes_short <- gsub("reporting specific elements", "reporting", fulldata$outcomes_short)
fulldata$outcomes_short <- gsub("completeness of reporting", "reporting", fulldata$outcomes_short)
fulldata$outcomes_short <- gsub("type-I error reduction", "type I error", fulldata$outcomes_short)
fulldata$outcomes_short <- gsub("percentage inconsistencies", "inconsistencies", fulldata$outcomes_short)
fulldata$outcomes_short <- gsub("data-sharing statements", "statements", fulldata$outcomes_short)
fulldata$outcomes_short <- gsub("other", "other outcomes", fulldata$outcomes_short)

fulldata$outcomes_specific <- gsub("Results replicability", "Results Replicability", fulldata$outcomes_specific)
fulldata$outcomes_class <- gsub("Inferential reproducibility", "Direct reproducibility", fulldata$outcomes_class)

# Change to proper case
fulldata$outcomes_class <- tools::toTitleCase(fulldata$outcomes_class)
fulldata$outcomes_short <- tools::toTitleCase(fulldata$outcomes_short)
fulldata$outcomes_specific <- tools::toTitleCase(fulldata$outcomes_specific)

fulldata$intervention_class <- tools::toTitleCase(fulldata$intervention_class)
fulldata$intervention_specific <- tools::toTitleCase(fulldata$intervention_specific)

fulldata$academic_field <- tools::toTitleCase(fulldata$academic_field)
fulldata$academic_field_short <- tools::toTitleCase(fulldata$academic_field_short)

fulldata$study_design_short <- factor(fulldata$study_design_short)
fulldata$study_design_short <- factor(tools::toTitleCase(as.character(fulldata$study_design_short)))
fulldata$study_design_short <- gsub("Post Only", "Post only", fulldata$study_design_short)

# Extract year from the author_year column
fulldata$year <- as.numeric(sub(".*\\((\\d{4})\\).*", "\\1", fulldata$author_year))

# Reordering the levels of 'outcomes_short'
# First, ensure that 'outcomes_short' is a factor with the correct number of levels
fulldata$outcomes_short <- factor(fulldata$outcomes_short)

# Define the new order for the levels of outcome_short
new_order_outcomes_short <- levels(fulldata$outcomes_short)[c(11,12,2,6,17,3,9,14,1,4,15,8,5,10,13,16,7)]

# Create a new variable 'outcomes_short_reordered' with the specified order
fulldata$outcomes_short_reordered <- factor(fulldata$outcomes_short, levels = new_order_outcomes_short)

# Reordering the levels of 'study_design_short'
fulldata$study_design_short <- factor(fulldata$study_design_short)
new_order_studydesign <- levels(fulldata$study_design_short)[c(1,5,3,4,2)]
fulldata$studydesign_reordered <- factor(fulldata$study_design_short, levels = new_order_studydesign)

# Reordering the levels of 'outcomes_class'
fulldata$outcomes_class <- factor(fulldata$outcomes_class)
new_order_outcomes_class <- levels(fulldata$outcomes_class)[c(1,2,6,4,8,7,3,5)]
fulldata$outcomes_class_reordered <- factor(fulldata$outcomes_class, levels = new_order_outcomes_class)

```


# Graph 1: Evidence Gap Map 1

## Intervention class vs outcomes

```{r fig.height=6, fig.width=10}
# Aggregate
df_count1 <- aggregate(author_year ~ intervention_class + outcomes_short_reordered + studydesign_reordered, data = fulldata, FUN = length)

# Order plots based on the highest number
df_count1 <- df_count1 %>%
  arrange(outcomes_short_reordered, desc(author_year)) %>%
  mutate(outcomes_short_reordered = factor(outcomes_short_reordered, levels = unique(new_order_outcomes_short)))

# Create evidence gap map (egm) 1
egm1 <- ggplot(df_count1, aes(x = outcomes_short_reordered, y = intervention_class, size = author_year, color = studydesign_reordered)) +
  geom_point(position = position_jitterdodge(jitter.width = .6, dodge.width = 0.7), alpha = 0.7) +
  scale_y_discrete(limits=rev)+
  scale_size_continuous(range = c(3, 12), labels = function(x) round(x,0)) + 
  labs(x = "Outcomes", y = "Class of interventions", size = "Number of studies", color = "Study design",
       caption = "Notes on study design: 
       Between = comparative (between-subject comparison)
       Within = comparative (within-subject comparison/repeated measures design)
       Post only = posttest design (only a post measurement after the implementation of an intervention and the intervention is explicitly mentioned)
       Other = other designs") +
  theme(plot.caption = element_text(hjust=0)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "right",
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1))

egm1
```


# Graph 2: Evidence Gap Map 2

## Intervention class vs outcomes class (with direct/proxy outcomes)

```{r fig.height=7, fig.width=12}
# Aggregate
df_count2 <- aggregate(author_year ~ intervention_class + outcomes_class_reordered + studydesign_reordered + direct, data = fulldata, FUN = length)

# Relabel 'direct' for clarity in plots
df_count2$direct <- factor(df_count2$direct, levels = c(1, 0), labels = c("Direct Outcomes", "Proxy Outcomes"))

# Order plots based on the highest number
df_count2 <- df_count2 %>%
  arrange(direct, desc(author_year)) %>%
  mutate(outcomes_class_reordered = factor(outcomes_class_reordered, levels = unique(new_order_outcomes_class)))

# Create evidence gap map 2
egm2 <- ggplot(df_count2, aes(x = outcomes_class_reordered, y = intervention_class, size = author_year, color = studydesign_reordered)) +
  geom_point(alpha = 0.7) +
  scale_y_discrete(limits=rev)+
  facet_wrap(~direct, scales = "free_x") +
  scale_size_continuous(range = c(3, 12), labels = function(x) round(x, 0)) +
  labs(x = "Outcomes", y = "Class of interventions", size = "Number of studies", color = "Study design",
       caption = "Notes on study design: 
       Between = comparative (between-subject comparison)
       Within = comparative (within-subject comparison/repeated measures design)
       Post only = posttest design (only a post measurement after the implementation of an intervention and the intervention is explicitly mentioned)
       Other = other designs")+
  theme(plot.caption = element_text(hjust=0)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "right",
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1))

egm2
```

# Additional graphs

## Graph 3: Intervention specific vs outcomes

```{r fig.height=7, fig.width=10}
# Aggregate
df_count3 <- aggregate(author_year ~ intervention_specific + outcomes_short_reordered + studydesign_reordered, data = fulldata, FUN = length)

# Order plots based on the highest number
df_count3 <- df_count3 %>%
  arrange(outcomes_short_reordered, desc(author_year)) %>%
  mutate(outcomes_short_reordered = factor(outcomes_short_reordered, levels = unique(new_order_outcomes_short)))

egm3 <- ggplot(df_count3, aes(x = outcomes_short_reordered, y = intervention_specific, size = author_year, color = studydesign_reordered)) +
  geom_point(position = position_jitterdodge(jitter.width = .6, dodge.width = 0.7), alpha = 0.7) +
  scale_size_continuous(range = c(3, 12), labels = function(x) round(x,0)) + 
  labs(x = "Outcomes", y = "Interventions (specific)", size = "Number of studies", color = "Study design",
       caption = "Notes on study design: 
       Between = comparative (between-subject comparison)
       Within = comparative (within-subject comparison/repeated measures design)
       Post only = posttest design (only a post measurement after the implementation of an intervention and the intervention is explicitly mentioned)
       Other = other designs")+
  theme(plot.caption = element_text(hjust=0)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "right",
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1)) 

egm3
```

## Graph 4: Author stated effect (Intervention specific vs outcomes)

```{r fig.height=7, fig.width=10}
# Count the number of author_year for each combination of intervention_specific and outcomes_short
df_count4 <- aggregate(author_year ~ intervention_specific + outcomes_short_reordered + author_stated_effect, data = fulldata, FUN = length)

# Order plots based on the highest number
df_count4 <- df_count4 %>%
  arrange(outcomes_short_reordered, desc(author_year)) %>%
  mutate(outcomes_short_reordered = factor(outcomes_short_reordered, levels = unique(new_order_outcomes_short)))

egm4 <- ggplot(df_count4, aes(x = outcomes_short_reordered, y = intervention_specific, size = author_year, color = author_stated_effect)) +
  geom_point(alpha = 0.7, shape = 21) +
  scale_size_continuous(range = c(3, 12), labels = function(x) round(x,0)) + 
  labs(x = "Outcomes", y = "Interventions (specific)", size = "Number of studies", color = "Author stated effect") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "right",
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1)) +
  scale_color_manual(values = c("red", "darkgreen", "blue"))

egm4
```

## Graph 5: Interventions (exact) vs Outcomes

```{r fig.height=12, fig.width=10}
# Aggregate
df_count5 <- aggregate(author_year ~ intervention_exact + outcomes_short_reordered + studydesign_reordered, data = fulldata, FUN = length)

egm5 <- ggplot(df_count5, aes(x = outcomes_short_reordered, y = intervention_exact, size = author_year, color = studydesign_reordered)) +
  geom_point(position = position_jitterdodge(jitter.width = .6, dodge.width = 0.7), alpha = 0.7) +
  scale_size_continuous(range = c(3, 12), labels = function(x) round(x,0)) + 
  labs(x = "Outcomes", y = "Interventions (exact)", size = "Number of studies", color = "Study design",
       caption = "Notes on study design: 
       Between = comparative (between-subject comparison)
       Within = comparative (within-subject comparison/repeated measures design)
       Post only = posttest design (only a post measurement after the implementation of an intervention and the intervention is explicitly mentioned)
       Other = other designs")+
  theme(plot.caption = element_text(hjust=0)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "right",
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1)) 

egm5
```


## Graph 6: Interventions (exact) vs outcomes (without study design)

```{r fig.height=12, fig.width=10}
# Count the number of author_year for each combination of intervention_exact and outcomes_short
df_count6 <- aggregate(author_year ~ intervention_exact + outcomes_short_reordered, data = fulldata, FUN = length)

egm6 <- ggplot(df_count6, aes(x = outcomes_short_reordered, y = intervention_exact, size = author_year)) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(range = c(3, 12), labels = function(x) round(x,0)) + 
  labs(x = "Outcomes", y = "Interventions (exact)", size = "Number of studies") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom",
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1)) 

egm6
```

# Basic Information

```{r include = FALSE}
pacman::p_load(flextable, gt, formattable, reactable, DT, rhandsontable)
set_flextable_defaults(fonts_ignore=TRUE)
```

## Author stated effect

```{r}
author_stated_effect_counts <- table(fulldata$author_stated_effect)
author_stated_effect_counts_df <- as.data.frame(author_stated_effect_counts)
names(author_stated_effect_counts_df)[1] <- "Author stated effect"
flextable::flextable(author_stated_effect_counts_df)
```

## Academic field

```{r}
library(ggplot2)

academic_field_short_counts <- table(fulldata$academic_field_short)
academic_field_short_df <- as.data.frame(academic_field_short_counts)

ggplot(academic_field_short_df, aes(x = reorder(Var1, Freq), y = Freq)) +
  geom_bar(stat = "identity", fill = "pink") +
  coord_flip() +
  xlab("Academic field") +
  ylab("Total number of studies") +
  theme_minimal()
```


## Number of studies over the year per academic field

```{r}

# Bar graph
ggplot(fulldata, aes(x = year, fill = academic_field_short)) +
  geom_bar() +
  scale_fill_brewer(palette = "Set3", name = "Academic field") +  
  labs(x = "Year", y = "Number of studies") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 12)) 
        
```


## List of interventions

```{r}
summary_interventions <- fulldata %>%
  group_by(intervention_class, intervention_specific) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percentage = round(Count / sum(Count) * 100, 2)) %>%
  rename(`Intervention Class` = intervention_class, 
         `Intervention Specific` = intervention_specific, 
         `n` = Count, 
         `%` = Percentage)

# Print the summary table
gt::gt(summary_interventions)
```


## List of outcomes

```{r}
# Replace values in 'direct' column in the df data frame
fulldata <- fulldata %>%
  mutate(direct = ifelse(direct == 1, "Direct", "Proxy"))

# Create a summary table of outcomes list
summary_outcomes <- fulldata %>%
  group_by(direct, outcomes_class_reordered, outcomes_short_reordered) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percentage = round(Count / sum(Count) * 100, 2)) %>%
  rename(`Outcomes` = direct,
         `Outcomes Class` = outcomes_class_reordered, 
         `Outcomes Specific` = outcomes_short_reordered, 
         `n` = Count, 
         `%` = Percentage)

# Print the summary table
gt::gt(summary_outcomes)
```

